package com.tcs.bancs.microservices.controller;

import java.io.File;
import java.nio.file.Paths;
import java.sql.Date;
import java.sql.SQLException;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.Base64;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Properties;
import org.apache.commons.lang3.StringUtils;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.sql.rowset.serial.SerialException;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.JsonMappingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.google.gson.Gson;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import com.tcs.bancs.microservices.RESBEAN;
import com.tcs.bancs.microservices.aggregator.AggregationServiceImpl;
import com.tcs.bancs.microservices.config.CacheConfig;
import com.tcs.bancs.microservices.configuration.PropertyLoader;
import com.tcs.bancs.microservices.repository.day.Login_flag_checkRepo;
import com.tcs.bancs.microservices.services.isFilePreviouslyProcessed;
import com.tcs.bancs.microservices.services.logtableupdatet1t2t3;
import com.tcs.bancs.microservices.services.sftputility;
import com.tcs.bancs.microservices.util.DBProcess;
import com.tcs.bancs.microservices.util.FrameworkConstants;

@RestController
@RequestMapping("/Fileupload")
public class FileUploadController {
	
	Logger logger = LoggerFactory.getLogger(FileUploadController.class);
	String ErrorCodeMasterFilePath = CacheConfig.frameworkConfigProperties.getProperty(FrameworkConstants.LOOKUP_FILES_PATH);
	
	Properties error = PropertyLoader.readPropertyFile(new String(ErrorCodeMasterFilePath + "/ErrorCodeMaster.properties"));
	Properties parameter=PropertyLoader.readPropertyFile(new String(ErrorCodeMasterFilePath + "/ServiceParameters.properties"));
	
	@Autowired
	AggregationServiceImpl aggregationServiceImpl;
	
	@Autowired
	Login_flag_checkRepo lf;
	
	@Autowired
	DBProcess dbprocess; 
	  
	@Autowired
	logtableupdatet1t2t3 update;
	
	@SuppressWarnings("unchecked")

	@PostMapping(value="/upload" ,produces = { "application/json" })
	public ResponseEntity<String> fileUpload(@RequestParam("file") MultipartFile file,@RequestParam("data") String jsonData,HttpServletRequest request,HttpServletResponse response) 
			throws  SQLException, JsonMappingException, JsonProcessingException
			{
		logger.info(ErrorCodeMasterFilePath);
		Gson gson = new Gson();
		RESBEAN resp = new RESBEAN();
		String finalResponse = new String();		
		String CLIENT_IP = request.getHeader("X-Forwarded-For");			
		ObjectMapper objmap = new ObjectMapper();
		Map<String, Object> data = new HashMap<>();
		data = objmap.readValue(jsonData, Map.class);		
		String reference_number = (String) data.get("REQUEST_REFERENCE_NUMBER");
		String source_id = (String) data.get("SOURCE_ID");
		String teller_id = (String) data.get("REQUEST_TELLER_ID");
		DateTimeFormatter Date = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss:SSS");
		LocalDateTime time = LocalDateTime.now();
		String RECD_TIME=Date.format(time);
		String teller_date=RECD_TIME.replace("-", "").substring(0, 9);
		response.setHeader("X-Content-Type-Options", "nosniff");
		response.setHeader("X-Frame-Options", "DENY");
		response.setHeader("Content-Security-Policy", "default-src 'self'");
		response.setHeader("X-XSS-Protection", "1;mode=block");
		response.setHeader("Strict-Transport-Security","max-age=31536000; includeSubDomains; preload");
		if(reference_number==null && source_id==null && teller_id==null){
			
			logger.error("Request Data is empty");			
			resp.setREQUEST_REFERENCE_NUMBER(null);
			resp.setSOURCE_ID(null);
			resp.setRESPONSE_STATUS(null);
			resp.setERROR_CODE("ER016");
			resp.setERROR_DESCRIPTION(error.getProperty("ER016"));
			finalResponse=gson.toJson(resp);
			boolean status=update.updatetable(reference_number,source_id,CLIENT_IP,teller_id,"1","ER016", error.getProperty("ER016"),Base64.getEncoder().encodeToString((jsonData).getBytes()),"Failure",RECD_TIME,Base64.getEncoder().encodeToString((finalResponse).getBytes()));
			if(status){
				logger.info("Database is updated");
			}
			else{
				logger.error("Error during the Database updation");
			}
			
			return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
			
		}
		
		else{
			
		if(reference_number==null ||reference_number.trim().isEmpty()) {
			
			logger.error("Request Reference number is empty");
			resp.setREQUEST_REFERENCE_NUMBER(reference_number);
			resp.setSOURCE_ID(source_id);
			resp.setRESPONSE_STATUS("1");
			resp.setERROR_CODE("ER015");
			resp.setERROR_DESCRIPTION(error.getProperty("ER015"));
			finalResponse=gson.toJson(resp);
			boolean status=update.updatetable(reference_number,source_id,CLIENT_IP,teller_id,"1","ER015", error.getProperty("ER015"),Base64.getEncoder().encodeToString((jsonData).getBytes()),"Failure",RECD_TIME,Base64.getEncoder().encodeToString((finalResponse).getBytes()));
			if(status){
				logger.info("Database is updated");
			}
			else{
				logger.error("Error during the Database updation");
			}
			
			return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
			
		}else if(reference_number.length()!=25) {
			
			logger.error("1:Request Reference number is invalid");
			resp.setREQUEST_REFERENCE_NUMBER(reference_number);
			resp.setSOURCE_ID(source_id);
			resp.setRESPONSE_STATUS("1");
			resp.setERROR_CODE("ER015");
			resp.setERROR_DESCRIPTION(error.getProperty("ER015"));
			finalResponse=gson.toJson(resp);
			boolean status=update.updatetable(reference_number,source_id,CLIENT_IP,teller_id,"1","ER015", error.getProperty("ER015"),Base64.getEncoder().encodeToString((jsonData).getBytes()),"Failure",RECD_TIME,Base64.getEncoder().encodeToString((finalResponse).getBytes()));
			if(status){
				logger.info("Database is updated");
			}
			else{
				logger.error("Error during the Database updation");
			}
			
			return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
			
		}else if(reference_number.length()==25){
			
			String sbi = reference_number.substring(0, 3);
			String s = reference_number.substring(3, reference_number.length());
			if(sbi.equals("SBI") &&  reference_number.matches("^(?![0-9]*$)[a-zA-Z0-9]+$") && StringUtils.isAlphanumeric(s)) {	
				
			}else {
				
				logger.error("2:Request Reference number is invalid");
				resp.setREQUEST_REFERENCE_NUMBER(reference_number);
				resp.setSOURCE_ID(source_id);
				resp.setRESPONSE_STATUS("1");
				resp.setERROR_CODE("ER015");
				resp.setERROR_DESCRIPTION(error.getProperty("ER015"));
				finalResponse = gson.toJson(resp);
				boolean status=update.updatetable(reference_number,source_id,CLIENT_IP,teller_id,"1","ER015", error.getProperty("ER015"),Base64.getEncoder().encodeToString((jsonData).getBytes()),"Failure",RECD_TIME,Base64.getEncoder().encodeToString((finalResponse).getBytes()));
				if(status){
					logger.info("Database is updated");
				}
				else{
					logger.error("Error during the Database updation");
				}
				
				return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
				
			}
		}
		
		 if(teller_id==null || teller_id.trim().isEmpty()) {
			
			logger.error("Request teller Id is empty");
			resp.setREQUEST_REFERENCE_NUMBER(reference_number);
			resp.setSOURCE_ID(source_id);
			resp.setRESPONSE_STATUS("1");
			resp.setERROR_CODE("ER023");
			resp.setERROR_DESCRIPTION(error.getProperty("ER023"));
			finalResponse=gson.toJson(resp);
			boolean status=update.updatetable(reference_number,source_id,CLIENT_IP,teller_id,"1","ER023", error.getProperty("ER023"),Base64.getEncoder().encodeToString((jsonData).getBytes()),"Failure",RECD_TIME,Base64.getEncoder().encodeToString((finalResponse).getBytes()));
			if(status){
				logger.info("Database is updated");
			}
			else{
				logger.error("Error during the Database updation");
			}
			
			return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
			
		}else if(!StringUtils.isNumeric(teller_id)) {
			
			logger.error("1:Request teller Id is invalid");
			resp.setREQUEST_REFERENCE_NUMBER(reference_number);
			resp.setSOURCE_ID(source_id);
			resp.setRESPONSE_STATUS("1");
			resp.setERROR_CODE("ER023");
			resp.setERROR_DESCRIPTION(error.getProperty("ER023"));
			finalResponse=gson.toJson(resp);
			boolean status=update.updatetable(reference_number,source_id,CLIENT_IP,teller_id,"1","ER023", error.getProperty("ER023"),Base64.getEncoder().encodeToString((jsonData).getBytes()),"Failure",RECD_TIME,Base64.getEncoder().encodeToString((finalResponse).getBytes()));
			if(status){
				logger.info("Database is updated");
			}
			else{
				logger.error("Error during the Database updation");
			}
			
			return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
			
		}else {
			
			teller_id=StringUtils.leftPad(teller_id, 7, "0");
			int count_of_teller_active=0;
			// Review points change by prathmesh
			try{
				if( teller_id != null) {
						count_of_teller_active=lf.findCountByAdlhDetails(teller_id,teller_date);
				   }
			}catch(NullPointerException e){
				 logger.error("Database access error while fectching count for teller number");
			}
			if (count_of_teller_active<1) {
				logger.error("User not Signed On");
				resp.setREQUEST_REFERENCE_NUMBER(reference_number);
				resp.setSOURCE_ID(source_id);
				resp.setRESPONSE_STATUS("1");
				resp.setERROR_CODE("ER024");
				resp.setERROR_DESCRIPTION(error.getProperty("ER024"));
				finalResponse=gson.toJson(resp);
				boolean status=update.updatetable(reference_number,source_id,CLIENT_IP,teller_id,"1","ER024", error.getProperty("ER024"),Base64.getEncoder().encodeToString((jsonData).getBytes()),"Failure",RECD_TIME,Base64.getEncoder().encodeToString((finalResponse).getBytes()));
				if(status){
					logger.info("Database is updated");
				}
				else{
					logger.error("Error during the Database updation");
				}
				
				return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
			}
			
			}
		}
		if(source_id==null ||  source_id.trim().isEmpty()) {
			
			logger.error("Source Id is empty");
			resp.setREQUEST_REFERENCE_NUMBER(reference_number);
			resp.setSOURCE_ID(source_id);
			resp.setRESPONSE_STATUS("1");
			resp.setERROR_CODE("ER020");
			resp.setERROR_DESCRIPTION(error.getProperty("ER020"));
			finalResponse=gson.toJson(resp);
			boolean status=update.updatetable(reference_number,source_id,CLIENT_IP,teller_id,"1","ER020", error.getProperty("ER020"),Base64.getEncoder().encodeToString((jsonData).getBytes()),"Failure",RECD_TIME,Base64.getEncoder().encodeToString((finalResponse).getBytes()));
			if(status){
				logger.info("Database is updated");
			}
			else{
				logger.error("Error during the Database updation");
			}
			
			return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
			
		}else if(source_id.length() > 5 || !StringUtils.isAlphanumeric(source_id)) {
			
			logger.error("Source Id is invalid");
			resp.setREQUEST_REFERENCE_NUMBER(reference_number);
			resp.setSOURCE_ID(source_id);
			resp.setRESPONSE_STATUS("1");
			resp.setERROR_CODE("ER020");
			resp.setERROR_DESCRIPTION(error.getProperty("ER020"));
			finalResponse=gson.toJson(resp);
			boolean status=update.updatetable(reference_number,source_id,CLIENT_IP,teller_id,"1","ER020", error.getProperty("ER020"),Base64.getEncoder().encodeToString((jsonData).getBytes()),"Failure",RECD_TIME,Base64.getEncoder().encodeToString((finalResponse).getBytes()));
			if(status){
				logger.info("Database is updated");
			}
			else{
				logger.error("Error during the Database updation");
			}
			
			return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
			
		}
		if(file.getSize()==0) {
			
			logger.error("File content is missing");
			resp.setREQUEST_REFERENCE_NUMBER(reference_number);
			resp.setSOURCE_ID(source_id);
			resp.setRESPONSE_STATUS("1");
			resp.setERROR_CODE("ER031");
			resp.setERROR_DESCRIPTION(error.getProperty("ER031"));
			finalResponse=gson.toJson(resp);
			boolean status=update.updatetable(reference_number,source_id,CLIENT_IP,teller_id,"1","ER031", error.getProperty("ER031"),Base64.getEncoder().encodeToString((jsonData).getBytes()),"Failure",RECD_TIME,Base64.getEncoder().encodeToString((finalResponse).getBytes()));
			if(status){
				logger.info("Database is updated");
			}
			else{
				logger.error("Error during the Database updation");
			}
			
			return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
			
		}
		 LocalDate date=LocalDate.now();
		
//		if(!isFilePreviouslyProcessed.isfilealreadyprocessed(file.getOriginalFilename(),date)){
//   
//        file.transferTo(Paths.get("\\\\10.0.30.13\\DinaShare\\Project Aadesh" + File.separator + file.getOriginalFilename()));
//		logger.info("File uploaded successfully");
//		resp.setREQUEST_REFERENCE_NUMBER(reference_number);
//		resp.setSOURCE_ID(source_id);
//		resp.setRESPONSE_STATUS("0");
//		resp.setERROR_CODE(null);
//		resp.setERROR_DESCRIPTION(null);
//		finalResponse=gson.toJson(resp);
//		boolean status=update.updatetable(reference_number,source_id,CLIENT_IP,teller_id,"0",null, null,Base64.getEncoder().encodeToString((jsonData).getBytes()),"Success",RECD_TIME,Base64.getEncoder().encodeToString((finalResponse).getBytes()));
//		if(status){
//			logger.info("Database is updated");
//		}
//		else{
//			logger.error("Error during the Database updation");
//		}
//		
//		return new ResponseEntity<String>(finalResponse, HttpStatus.OK);
//		}
//		else{
//	        
//		logger.error("File is already processed");
//			resp.setREQUEST_REFERENCE_NUMBER(reference_number);
//			resp.setSOURCE_ID(source_id);
//			resp.setRESPONSE_STATUS("1");
//			resp.setERROR_CODE("ER003");
//			resp.setERROR_DESCRIPTION(error.getProperty("ER003"));
//			finalResponse=gson.toJson(resp);
//			boolean status=update.updatetable(reference_number,source_id,CLIENT_IP,teller_id,"1","ER003", error.getProperty("ER003"),Base64.getEncoder().encodeToString((jsonData).getBytes()),"Failure",RECD_TIME,Base64.getEncoder().encodeToString((finalResponse).getBytes()));
//			if(status){
//			logger.info("Database is updated");
//			}
//			else{
//				logger.error("Error during the Database updation");
//			}
//        
//		return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
//        
//		}
		if(!isFilePreviouslyProcessed.isfilealreadyprocessed(file.getOriginalFilename(),date)){
        
		if(sftputility.sftpconnection()) {
        
			logger.info("Connection establised succesfully");
			String remoteDir= parameter.getProperty("remoteDirUpload");
        
			if(sftputility.upload(remoteDir, file)) {
        
				logger.info("File uploaded successfully to remoteDir");
				sftputility.disconnect();
				logger.info("Connection disconnected");
				resp.setREQUEST_REFERENCE_NUMBER(reference_number);
				resp.setSOURCE_ID(source_id);
				resp.setRESPONSE_STATUS("0");
				resp.setERROR_CODE(null);
				resp.setERROR_DESCRIPTION(null);
				finalResponse=gson.toJson(resp);
				boolean status=update.updatetable(reference_number,source_id,CLIENT_IP,teller_id,"0",null, null,Base64.getEncoder().encodeToString((jsonData).getBytes()),"Success",RECD_TIME,Base64.getEncoder().encodeToString((finalResponse).getBytes()));
				if(status){
				logger.info("Database is updated");
				}
								else{
				logger.error("Error during the Database updation");
				}
					
				return new ResponseEntity<String>(finalResponse, HttpStatus.OK);
				
			}else {
        
				logger.error("Error during the file upload");
				sftputility.disconnect();
				logger.info("Connection disconnected");
				resp.setREQUEST_REFERENCE_NUMBER(reference_number);
				resp.setSOURCE_ID(source_id);
				resp.setRESPONSE_STATUS("1");
				resp.setERROR_CODE("ER033");
				resp.setERROR_DESCRIPTION(error.getProperty("ER033"));
				finalResponse=gson.toJson(resp);
				boolean status=update.updatetable(reference_number,source_id,CLIENT_IP,teller_id,"1","ER033", error.getProperty("ER033"),Base64.getEncoder().encodeToString((jsonData).getBytes()),"Failure",RECD_TIME,Base64.getEncoder().encodeToString((finalResponse).getBytes()));
				if(status){
					logger.info("Database is updated");
				}
				else{
					logger.error("Error during the Database updation");
				}
        
				return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
				
			}	
		}else {
        
			logger.error("Error in establishing a connection");
			resp.setREQUEST_REFERENCE_NUMBER(reference_number);
		resp.setSOURCE_ID(source_id);
			resp.setRESPONSE_STATUS("1");
			resp.setERROR_CODE("ER032");
		resp.setERROR_DESCRIPTION(error.getProperty("ER032"));
			finalResponse=gson.toJson(resp);
			boolean status=update.updatetable(reference_number,source_id,CLIENT_IP,teller_id,"1","ER032", error.getProperty("ER032"),Base64.getEncoder().encodeToString((jsonData).getBytes()),"Failure",RECD_TIME,Base64.getEncoder().encodeToString((finalResponse).getBytes()));
			if(status){
				logger.info("Database is updated");
			}
			else{
				logger.error("Error during the Database updation");
		}
        
			return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
        
			}
		}else{
        
			logger.error("File is already processed");
			resp.setREQUEST_REFERENCE_NUMBER(reference_number);
			resp.setSOURCE_ID(source_id);
			resp.setRESPONSE_STATUS("1");
			resp.setERROR_CODE("ER003");
			resp.setERROR_DESCRIPTION(error.getProperty("ER003"));
			finalResponse=gson.toJson(resp);
			boolean status=update.updatetable(reference_number,source_id,CLIENT_IP,teller_id,"1","ER003", error.getProperty("ER003"),Base64.getEncoder().encodeToString((jsonData).getBytes()),"Failure",RECD_TIME,Base64.getEncoder().encodeToString((finalResponse).getBytes()));
			if(status){
				logger.info("Database is updated");
			}
			else{
				logger.error("Error during the Database updation");
						}
        
			return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
        
	}
	}
}

