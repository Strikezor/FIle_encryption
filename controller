package com.tcs.bancs.microservices.controller;

import java.sql.Date;
import java.text.SimpleDateFormat;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.Base64;
import java.util.Comparator;
import java.util.List;
import java.util.Properties;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestHeader;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.google.gson.Gson;
import com.tcs.bancs.microservices.REQ_ENC;
import com.tcs.bancs.microservices.config.CacheConfig;
import com.tcs.bancs.microservices.configuration.PropertyLoader;
import com.tcs.bancs.microservices.impl.MigenqDebitDetailsRepositoryImpl;
import com.tcs.bancs.microservices.repository.day.ACH_ENC_REPO_DEBIT;
import com.tcs.bancs.microservices.repository.day.Login_flag_checkRepo;
import com.tcs.bancs.microservices.response.ADESH_ENC_FILE_RETURN;
import com.tcs.bancs.microservices.response.Response;
import com.tcs.bancs.microservices.services.filterCheck;
import com.tcs.bancs.microservices.util.FrameworkConstants;

@RestController
@Controller 
@RequestMapping("/EncFile")
public class ACHENC_DEBIT_CONTROLLER {
	@Autowired
	ACH_ENC_REPO_DEBIT achencrepodebit;

	@Autowired
	MigenqDebitDetailsRepositoryImpl migDetails;
	

	
	@Autowired
	Login_flag_checkRepo lf;
	
	@Autowired
	filterCheck Customfilter;
	String ErrorCodeMasterFilePath = CacheConfig.frameworkConfigProperties
			.getProperty(FrameworkConstants.LOOKUP_FILES_PATH);
	Properties error = PropertyLoader
			.readPropertyFile(new String(ErrorCodeMasterFilePath + "/ErrorCodeMaster.properties"));
	
	@CrossOrigin(origins="http://localhost:4200")
	@PostMapping(value = { "/CheckFiles-Debit" }, produces = { "application/json" })
	public ResponseEntity<String> FileResponce2(@RequestBody(required = false) REQ_ENC reqbean,
			HttpServletRequest request, @RequestHeader HttpHeaders headers, HttpServletResponse response) {
		
		
		Gson gson = new Gson();
		String finalResponse = "";
		String remoteAddress = request.getRemoteAddr();
		String tellerNo = new String();
		String SourceId = "";
		String ReqRefNo = null;  
		String txn_no = "901903";
		String txn_name = "ACH DEBIT RETURN FILE DOWNLOAD";
		DateTimeFormatter entryDate1 = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss:SSS");
		LocalDateTime timex = LocalDateTime.now();
		String entryDate = entryDate1.format(timex);
		String teller_date=entryDate.replace("-", "").substring(0, 9);
		//String CLIENT_IP = request.getHeader("X-Forwarded-For");
		String CLIENT_IP =  request.getLocalAddr();
		ADESH_ENC_FILE_RETURN result =new ADESH_ENC_FILE_RETURN();
		
		
		try{
			if (reqbean != null) {

				ReqRefNo = reqbean.getRequest_reference_number();
			} else {
				result.setERROR_CODE("ER016");
				result.setERROR_DESCRIPTION(error.getProperty("ER016"));
				result.setSOURCE_ID(SourceId);
				result.setRESPONSE_STATUS("1");
				result.setREQUEST_REFERENCE_NUMBER(ReqRefNo);
				finalResponse = gson.toJson(result);
				
			if (!Customfilter.Filter(finalResponse,false)) {

					return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
				}
			}
			if(reqbean!=null){
				String dateinString=reqbean.getFILE_RECEIVED_DATE();
				ReqRefNo = reqbean.getRequest_reference_number();
				SourceId = reqbean.getSource_id();
				tellerNo=reqbean.getRequest_teller_id();
				String cleanedString="";
				String reqbeanstr = "";
				if(dateinString.length()==10){
					cleanedString = dateinString.replace("/", "");
				} else {
					result.setERROR_CODE("ER029");
					result.setERROR_DESCRIPTION(error.getProperty("ER029"));
					result.setSOURCE_ID(SourceId);
					result.setRESPONSE_STATUS("1");
					result.setREQUEST_REFERENCE_NUMBER(ReqRefNo);
					finalResponse = gson.toJson(result);
					reqbeanstr = gson.toJson(reqbean).toString();
					migDetails.LogData("1", Base64.getEncoder().encodeToString((reqbeanstr).getBytes()),
							Base64.getEncoder().encodeToString((finalResponse).getBytes()), remoteAddress,
							tellerNo, "ER029", error.getProperty("ER029"), reqbean.getRequest_reference_number(),
							reqbean.getSource_id(), "Failure", entryDate, CLIENT_IP,txn_no,txn_name);
					
					if (!Customfilter.Filter(finalResponse,false)) {

						return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
					}
				}
		        
				if (ReqRefNo == null || ReqRefNo.length() != 25 || ReqRefNo.isEmpty()) {
					result.setERROR_CODE("ER015");
					result.setERROR_DESCRIPTION(error.getProperty("ER015"));
					result.setSOURCE_ID(SourceId);
					result.setRESPONSE_STATUS("1");
					result.setREQUEST_REFERENCE_NUMBER(ReqRefNo);
					finalResponse = gson.toJson(result);
					reqbeanstr = gson.toJson(reqbean).toString();
			
					migDetails.LogData("1", Base64.getEncoder().encodeToString((reqbeanstr).getBytes()),
							Base64.getEncoder().encodeToString((finalResponse).getBytes()), remoteAddress, tellerNo,
							"ER015", error.getProperty("ER015"), reqbean.getRequest_reference_number(),
							reqbean.getSource_id(), "Failure", entryDate, CLIENT_IP,txn_no,txn_name);

				if (!Customfilter.Filter(finalResponse,false)) {

						return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
					}

				}else if(ReqRefNo.length()==25){

					String sbi = ReqRefNo.substring(0, 3);
					String s = ReqRefNo.substring(3, ReqRefNo.length());
					if(sbi.equals("SBI") &&  ReqRefNo.matches("^(?![0-9]*$)[a-zA-Z0-9]+$") && StringUtils.isAlphanumeric(s)) {	
						
					}else {
						result.setERROR_CODE("ER015");
						result.setERROR_DESCRIPTION(error.getProperty("ER015"));
						result.setSOURCE_ID(SourceId);
						result.setRESPONSE_STATUS("1");
						result.setREQUEST_REFERENCE_NUMBER(ReqRefNo);
						finalResponse = gson.toJson(result);
						reqbeanstr = gson.toJson(reqbean).toString();
				
						migDetails.LogData("1", Base64.getEncoder().encodeToString((reqbeanstr).getBytes()),
								Base64.getEncoder().encodeToString((finalResponse).getBytes()), remoteAddress, tellerNo,
								"ER015", error.getProperty("ER015"), reqbean.getRequest_reference_number(),
								reqbean.getSource_id(), "Failure", entryDate, CLIENT_IP,txn_no,txn_name);

					if (!Customfilter.Filter(finalResponse,false)) {

							return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
						}

					}
				}
				
				if (SourceId == null || !StringUtils.isAlphanumeric(SourceId) || SourceId.contains(" ")
						|| SourceId.length() >= 6 || SourceId.isEmpty()) {
					result.setERROR_CODE("ER020");
					result.setERROR_DESCRIPTION(error.getProperty("ER020"));
					result.setSOURCE_ID(SourceId);
					result.setRESPONSE_STATUS("1");
					result.setREQUEST_REFERENCE_NUMBER(ReqRefNo);
					finalResponse = gson.toJson(result);
					reqbeanstr = gson.toJson(reqbean).toString();
					migDetails.LogData("1", Base64.getEncoder().encodeToString((reqbeanstr).getBytes()),
							Base64.getEncoder().encodeToString((finalResponse).getBytes()), remoteAddress, tellerNo,
							"ER020", error.getProperty("ER020"), reqbean.getRequest_reference_number(),
							reqbean.getSource_id(), "Failure", entryDate, CLIENT_IP,txn_no,txn_name);
					if (!Customfilter.Filter(finalResponse,false)) {

						return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
					}
				} 
				
				if ( tellerNo == null || tellerNo.equals("") || tellerNo.isEmpty() ) {
					result.setERROR_CODE("ER023");
					result.setERROR_DESCRIPTION(error.getProperty("ER023"));
					result.setSOURCE_ID(SourceId);
					result.setRESPONSE_STATUS("1");
					result.setREQUEST_REFERENCE_NUMBER(ReqRefNo);
					finalResponse = gson.toJson(result);
					reqbeanstr = gson.toJson(reqbean).toString();
					migDetails.LogData("1", Base64.getEncoder().encodeToString((reqbeanstr).getBytes()),
							Base64.getEncoder().encodeToString((finalResponse).getBytes()), remoteAddress,
							tellerNo, "ER023", error.getProperty("ER023"), reqbean.getRequest_reference_number(),
							reqbean.getSource_id(), "Failure", entryDate, CLIENT_IP,txn_no,txn_name);

					if (!Customfilter.Filter(finalResponse,false)) {

						return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
					}
				} else {
					tellerNo=StringUtils.leftPad(tellerNo, 7, "0");
					int count_of_teller_active=0;
				
						count_of_teller_active=lf.findCountByAdlhDetails(tellerNo,teller_date);
						
//					if (count_of_teller_active<1) {
//						result.setERROR_CODE("ER024");
//						result.setERROR_DESCRIPTION(error.getProperty("ER024"));
//						result.setSOURCE_ID(SourceId);
//						result.setRESPONSE_STATUS("1");
//						result.setREQUEST_REFERENCE_NUMBER(ReqRefNo);
//						finalResponse = gson.toJson(result);
//						reqbeanstr = gson.toJson(reqbean).toString();
//						migDetails.LogData("1", Base64.getEncoder().encodeToString((reqbeanstr).getBytes()),
//								Base64.getEncoder().encodeToString((finalResponse).getBytes()), remoteAddress,
//								tellerNo, "ER024", error.getProperty("ER024"), reqbean.getRequest_reference_number(),
//								reqbean.getSource_id(), "failure", entryDate, CLIENT_IP,txn_no,txn_name);
//  
//						if (!Customfilter.Filter(finalResponse,false)) {
//
//							return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
//						}
//					}
					
					/*
					 * if (count_of_teller_active>1) { result.setERROR_CODE("ER024");
					 * result.setERROR_DESCRIPTION(error.getProperty("ER024"));
					 * result.setSOURCE_ID(SourceId); result.setRESPONSE_STATUS("1");
					 * result.setREQUEST_REFERENCE_NUMBER(ReqRefNo); finalResponse =
					 * gson.toJson(result); reqbeanstr = gson.toJson(reqbean).toString();
					 * migDetails.LogData("1",
					 * Base64.getEncoder().encodeToString((reqbeanstr).getBytes()),
					 * Base64.getEncoder().encodeToString((finalResponse).getBytes()),
					 * remoteAddress, tellerNo, "ER024", error.getProperty("ER024"),
					 * reqbean.getRequest_reference_number(), reqbean.getSource_id(), "Failure",
					 * entryDate, CLIENT_IP,txn_no,txn_name);
					 * 
					 * if (!Customfilter.Filter(finalResponse,false)) {
					 * 
					 * return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST); } }
					 */
				}
				
				String settlement_date=cleanedString;
				String day = settlement_date.substring(0, 2); 
		        String month = settlement_date.substring(2, 4); 
		        String year = settlement_date.substring(4, 8); 
		        String settle_date = year + "-" + month + "-" + day;
				Date sqlDate = Date.valueOf(settle_date);
				
				List<Object[]> HeaderResult=achencrepodebit.getfiles(sqlDate);
				List<Response> files=new ArrayList<>();
				if(!HeaderResult.isEmpty()){
					for (Object[] row : HeaderResult) {
						Response res=new Response();
						res.setFILE_NAME(row[0].toString()); 
						String dateandtime=(row[1].toString());
						
						SimpleDateFormat originalFormat = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss.SSS");
						java.util.Date time = originalFormat.parse(dateandtime);
						SimpleDateFormat newFormat = new SimpleDateFormat("HH:mm:ss");
						String formattedDate = newFormat.format(time);
						
						res.setLAST_UODATED_TIME(formattedDate);
						files.add(res);
					}
				} else {
					result.setERROR_CODE("ER026");
					result.setERROR_DESCRIPTION(error.getProperty("ER026"));
					result.setSOURCE_ID(SourceId);
					result.setRESPONSE_STATUS("1");
					result.setREQUEST_REFERENCE_NUMBER(ReqRefNo);
					finalResponse = gson.toJson(result);
					reqbeanstr = gson.toJson(reqbean).toString();
					migDetails.LogData("1", Base64.getEncoder().encodeToString((reqbeanstr).getBytes()),
							Base64.getEncoder().encodeToString((finalResponse).getBytes()), remoteAddress,
							tellerNo, "ER026", error.getProperty("ER026"), reqbean.getRequest_reference_number(),
							reqbean.getSource_id(), "Failure", entryDate, CLIENT_IP,txn_no,txn_name);
				if (!Customfilter.Filter(finalResponse,false)) {

						return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
					}
				}
				files.sort(Comparator.comparing(Response::getLAST_UODATED_TIME).thenComparing(Response::getFILE_NAME));
				result.setResponse(files);
				result.setERROR_CODE("");
				result.setERROR_DESCRIPTION("");
				result.setSOURCE_ID(SourceId);
				result.setRESPONSE_STATUS("0");
				result.setREQUEST_REFERENCE_NUMBER(ReqRefNo);
				finalResponse = gson.toJson(result);
				
				reqbeanstr = gson.toJson(reqbean).toString();
				migDetails.LogData("0", Base64.getEncoder().encodeToString((reqbeanstr).getBytes()),
						Base64.getEncoder().encodeToString((finalResponse).getBytes()), remoteAddress, tellerNo,
						"","", reqbean.getRequest_reference_number(),
						reqbean.getSource_id(), "Success", entryDate, CLIENT_IP,txn_no,txn_name);

				return new ResponseEntity<String>(finalResponse, HttpStatus.OK);
			}
		} catch(Exception e){
			result.setERROR_CODE("ER017");
			result.setERROR_DESCRIPTION(error.getProperty("ER017"));
			result.setSOURCE_ID(SourceId);
			result.setRESPONSE_STATUS("1");
			result.setREQUEST_REFERENCE_NUMBER(ReqRefNo);
			finalResponse = gson.toJson(result);
			String reqbeanstr = gson.toJson(reqbean).toString();
			try { 
				migDetails.LogData("1", Base64.getEncoder().encodeToString((reqbeanstr).getBytes()),
						Base64.getEncoder().encodeToString((finalResponse).getBytes()), remoteAddress,
						tellerNo, "ER017", error.getProperty("ER017"), reqbean.getRequest_reference_number(),
						reqbean.getSource_id(), "Failure", entryDate, CLIENT_IP,txn_no,txn_name);
			} catch (Exception e1) {
					return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
			}
			if (!Customfilter.Filter(finalResponse,false)) {

				return new ResponseEntity<String>(finalResponse, HttpStatus.BAD_REQUEST);
			}
		}
		return null;
	}
}
